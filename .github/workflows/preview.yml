name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # DEPLOY PREVIEW
  # ============================================
  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read
    
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_APP_URL: https://${{ github.event.pull_request.head.sha }}-privacy-cash.vercel.app
          NEXT_PUBLIC_SOLANA_RPC_URL: https://api.devnet.solana.com
          NEXT_PUBLIC_SOLANA_NETWORK: devnet

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Get Deployment ID
        id: deployment-id
        run: |
          DEPLOYMENT_ID=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} | head -2 | tail -1 | awk '{print $1}')
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

  # ============================================
  # COMMENT ON PR
  # ============================================
  comment:
    name: ğŸ’¬ Comment Preview Link
    runs-on: ubuntu-latest
    needs: deploy-preview
    
    permissions:
      pull-requests: write
    
    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ğŸš€ Preview Deployment'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## ğŸš€ Preview Deployment
            
            | Status | URL |
            |--------|-----|
            | âœ… Ready | [${{ needs.deploy-preview.outputs.preview-url }}](${{ needs.deploy-preview.outputs.preview-url }}) |
            
            ### ğŸ“± QR Code
            
            ![QR Code](https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${{ needs.deploy-preview.outputs.preview-url }})
            
            ### ğŸ”— Quick Links
            
            - ğŸ  [Home](${{ needs.deploy-preview.outputs.preview-url }})
            - ğŸ’° [Deposit](${{ needs.deploy-preview.outputs.preview-url }}/?action=deposit)
            - ğŸ’¸ [Withdraw](${{ needs.deploy-preview.outputs.preview-url }}/?action=withdraw)
            
            ### ğŸ“Š Deployment Info
            
            | Property | Value |
            |----------|-------|
            | Branch | `${{ github.head_ref }}` |
            | Commit | `${{ github.event.pull_request.head.sha }}` |
            | Network | Devnet |
            
            ---
            
            <details>
            <summary>ğŸ§ª Test Checklist</summary>
            
            - [ ] Wallet connection works
            - [ ] Deposit form displays correctly
            - [ ] Withdraw form displays correctly
            - [ ] Mobile responsive
            - [ ] Dark mode looks correct
            - [ ] No console errors
            
            </details>
            
            ---
            *Deployed by Privacy Cash CI â€¢ [View Logs](https://vercel.com/privacy-cash/privacy-cash-ecosystem/deployments)*

  # ============================================
  # LIGHTHOUSE AUDIT
  # ============================================
  lighthouse:
    name: ğŸ”¦ Lighthouse Audit
    runs-on: ubuntu-latest
    needs: deploy-preview
    
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v12
        id: lighthouse
        with:
          urls: |
            ${{ needs.deploy-preview.outputs.preview-url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Format Lighthouse Score
        id: format-score
        uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};
            
            if (!results || results.length === 0) {
              core.setOutput('comment', 'Lighthouse audit failed to run.');
              return;
            }
            
            const result = results[0];
            const summary = result.summary;
            
            const formatScore = (score) => {
              if (score === null) return 'â“';
              const percentage = Math.round(score * 100);
              if (percentage >= 90) return `ğŸŸ¢ ${percentage}`;
              if (percentage >= 50) return `ğŸŸ¡ ${percentage}`;
              return `ğŸ”´ ${percentage}`;
            };
            
            const comment = `## ğŸ”¦ Lighthouse Audit
            
            | Metric | Score |
            |--------|-------|
            | Performance | ${formatScore(summary.performance)} |
            | Accessibility | ${formatScore(summary.accessibility)} |
            | Best Practices | ${formatScore(summary['best-practices'])} |
            | SEO | ${formatScore(summary.seo)} |
            
            [ğŸ“Š Full Report](${Object.values(links)[0]})`;
            
            core.setOutput('comment', comment);

      - name: Comment Lighthouse Results
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.format-score.outputs.comment }}
